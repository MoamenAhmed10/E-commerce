<section class="product-reviews">
  <div class="reviews-header">
    <div class="reviews-summary">
      <h3>Customer Reviews</h3>
      <div class="rating-summary">
        <div class="average-rating">
          <span class="rating-number">{{ stats().averageRating | number: '1.1-1' }}</span>
          <div class="stars">
            @for (star of getFilledStars(stats().averageRating); track $index) {
              <span class="star filled">★</span>
            }
            @for (star of getEmptyStars(stats().averageRating); track $index) {
              <span class="star empty">☆</span>
            }
          </div>
          <span class="total-reviews">{{ stats().totalReviews }} reviews</span>
        </div>
      </div>
    </div>
    <button class="btn btn-primary" (click)="toggleReviewForm()">
      @if (showReviewForm()) {
        Cancel
      } @else {
        Write a Review
      }
    </button>
  </div>

  <!-- Review Form -->
  @if (showReviewForm()) {
    <div class="review-form-container">
      <form class="review-form" (ngSubmit)="submitReview()">
        <h4>Write Your Review</h4>

        <!-- Order Selection -->
        <div class="form-group">
          <label for="orderId">Select Order *</label>
          <select
            id="orderId"
            [(ngModel)]="selectedOrderId"
            name="orderId"
            class="form-control"
            required
          >
            <option value="">Choose an order...</option>
            @for (order of deliveredOrders; track order._id) {
              <option [value]="order._id">
                Order #{{ order.orderNumber }} - {{ order.createdAt | date: 'mediumDate' }}
              </option>
            }
          </select>
        </div>

        <!-- Rating -->
        <div class="form-group">
          <label>Rating *</label>
          <div class="star-rating-input">
            @for (star of getStarArray(); track star) {
              <button
                type="button"
                class="star-btn"
                [class.active]="star <= rating"
                (click)="setRating(star)"
              >
                {{ star <= rating ? '★' : '☆' }}
              </button>
            }
          </div>
        </div>

        <!-- Title -->
        <div class="form-group">
          <label for="title">Review Title (Optional)</label>
          <input
            type="text"
            id="title"
            [(ngModel)]="title"
            name="title"
            class="form-control"
            placeholder="Summarize your review"
            maxlength="100"
          />
        </div>

        <!-- Comment -->
        <div class="form-group">
          <label for="comment">Your Review (Optional)</label>
          <textarea
            id="comment"
            [(ngModel)]="comment"
            name="comment"
            class="form-control"
            rows="4"
            placeholder="Share your experience with this product"
            maxlength="1000"
          ></textarea>
        </div>

        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="isSubmitting() || !selectedOrderId"
        >
          @if (isSubmitting()) {
            <span class="spinner"></span> Submitting...
          } @else {
            Submit Review
          }
        </button>
      </form>
    </div>
  }

  <!-- Reviews List -->
  <div class="reviews-list">
    @if (isLoading()) {
      <div class="loading-reviews">
        <div class="spinner"></div>
        <p>Loading reviews...</p>
      </div>
    } @else if (reviews().length === 0) {
      <div class="no-reviews">
        <p>No reviews yet. Be the first to review this product!</p>
      </div>
    } @else {
      @for (review of reviews(); track review._id) {
        <div class="review-card">
          <div class="review-header">
            <div class="reviewer-info">
              <span class="reviewer-name">{{ getUserName(review) }}</span>
              <span class="review-date">{{ formatDate(review.createdAt) }}</span>
            </div>
            <div class="review-rating">
              @for (star of getFilledStars(review.rating); track $index) {
                <span class="star filled">★</span>
              }
              @for (star of getEmptyStars(review.rating); track $index) {
                <span class="star empty">☆</span>
              }
            </div>
          </div>
          @if (review.title) {
            <h5 class="review-title">{{ review.title }}</h5>
          }
          @if (review.comment) {
            <p class="review-comment">{{ review.comment }}</p>
          }
        </div>
      }

      <!-- Pagination -->
      @if (totalPages() > 1) {
        <div class="reviews-pagination">
          <button
            class="btn btn-secondary"
            [disabled]="currentPage() <= 1"
            (click)="onPageChange(currentPage() - 1)"
          >
            Previous
          </button>
          <span class="page-info">Page {{ currentPage() }} of {{ totalPages() }}</span>
          <button
            class="btn btn-secondary"
            [disabled]="currentPage() >= totalPages()"
            (click)="onPageChange(currentPage() + 1)"
          >
            Next
          </button>
        </div>
      }
    }
  </div>
</section>
