<div class="admin-categories">
  <div class="page-header">
    <h1>Categories</h1>
    <button class="btn btn-primary" (click)="openCategoryForm()">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="M5 12h14" />
        <path d="M12 5v14" />
      </svg>
      Add Category
    </button>
  </div>

  @if (isLoading()) {
    <app-loading [center]="true" message="Loading categories..." />
  } @else {
    <div class="categories-grid">
      @for (category of categories(); track category._id) {
        <div class="category-card" [class.inactive]="!category.isActive">
          <div class="category-header">
            <div class="category-info">
              @if (category.image) {
                <img [src]="category.image" [alt]="category.name" class="category-image" />
              }
              <div>
                <h3>{{ category.name }}</h3>
                <span class="slug">{{ category.slug }}</span>
              </div>
            </div>
            <div class="category-actions">
              <button class="btn-icon" (click)="editCategory(category)" title="Edit">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                </svg>
              </button>
              <button
                class="btn-icon"
                (click)="toggleCategory(category)"
                [title]="category.isActive ? 'Deactivate' : 'Activate'"
              >
                @if (category.isActive) {
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                    <circle cx="12" cy="12" r="3" />
                  </svg>
                } @else {
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"
                    />
                    <line x1="1" y1="1" x2="23" y2="23" />
                  </svg>
                }
              </button>
            </div>
          </div>

          <!-- Subcategories -->
          <div class="subcategories">
            <div class="subcategories-header">
              <span>Subcategories ({{ category.subcategories?.length || 0 }})</span>
              <button class="btn-add-sub" (click)="openSubcategoryForm(category)">+ Add</button>
            </div>
            @if (category.subcategories && category.subcategories.length > 0) {
              <div class="subcategory-list">
                @for (sub of category.subcategories; track sub._id) {
                  <div class="subcategory-item" [class.inactive]="!sub.isActive">
                    <span>{{ sub.name }}</span>
                    <div class="sub-actions">
                      <button
                        class="btn-icon-sm"
                        (click)="editSubcategory(sub, category)"
                        title="Edit"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="14"
                          height="14"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        >
                          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                        </svg>
                      </button>
                      <button class="btn-icon-sm" (click)="toggleSubcategory(sub)" title="Toggle">
                        @if (sub.isActive) {
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="14"
                            height="14"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          >
                            <polyline points="20 6 9 17 4 12" />
                          </svg>
                        } @else {
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="14"
                            height="14"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                          </svg>
                        }
                      </button>
                    </div>
                  </div>
                }
              </div>
            } @else {
              <p class="no-subcategories">No subcategories yet</p>
            }
          </div>
        </div>
      } @empty {
        <div class="empty-state">
          <p>No categories yet. Create your first category to get started.</p>
        </div>
      }
    </div>
  }
</div>

<!-- Category Form Modal -->
@if (showCategoryForm) {
  <div class="modal-overlay" (click)="closeCategoryForm()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>{{ editingCategory ? 'Edit Category' : 'Add Category' }}</h3>
      <form [formGroup]="categoryForm" (ngSubmit)="saveCategory()">
        <div class="form-group">
          <label>Name *</label>
          <input type="text" formControlName="name" placeholder="Category name" />
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea
            formControlName="description"
            placeholder="Category description"
            rows="3"
          ></textarea>
        </div>
        <div class="form-group">
          <label>Image URL</label>
          <input type="text" formControlName="image" placeholder="https://..." />
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-outline" (click)="closeCategoryForm()">
            Cancel
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="isSaving() || categoryForm.invalid"
          >
            {{ isSaving() ? 'Saving...' : editingCategory ? 'Update' : 'Create' }}
          </button>
        </div>
      </form>
    </div>
  </div>
}

<!-- Subcategory Form Modal -->
@if (showSubcategoryForm) {
  <div class="modal-overlay" (click)="closeSubcategoryForm()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>{{ editingSubcategory ? 'Edit Subcategory' : 'Add Subcategory' }}</h3>
      <p class="modal-subtitle">Category: {{ parentCategory?.name }}</p>
      <form [formGroup]="subcategoryForm" (ngSubmit)="saveSubcategory()">
        <div class="form-group">
          <label>Name *</label>
          <input type="text" formControlName="name" placeholder="Subcategory name" />
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea
            formControlName="description"
            placeholder="Subcategory description"
            rows="3"
          ></textarea>
        </div>
        <div class="form-group">
          <label>Image URL</label>
          <input type="text" formControlName="image" placeholder="https://..." />
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-outline" (click)="closeSubcategoryForm()">
            Cancel
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="isSaving() || subcategoryForm.invalid"
          >
            {{ isSaving() ? 'Saving...' : editingSubcategory ? 'Update' : 'Create' }}
          </button>
        </div>
      </form>
    </div>
  </div>
}
